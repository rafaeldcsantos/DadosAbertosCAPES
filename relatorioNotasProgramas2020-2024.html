<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Relatório de Mudança de Notas (2020/2024)</title>
    <link rel="icon" type="image/svg+xml" href="./Images/favicon.svg" />
    <link rel="stylesheet" href="./CSS/site.css" />
    <style>
      .report-controls {
        display: grid;
        grid-template-columns:
          minmax(260px, 2.2fr)
          minmax(180px, 1.2fr)
          minmax(120px, 0.8fr)
          minmax(230px, 1.8fr);
        align-items: end;
        gap: 8px;
        margin-bottom: 12px;
      }

      .report-controls .control {
        display: grid;
        gap: 4px;
        min-width: 0;
      }

      .report-controls label {
        font-size: 0.84rem;
        font-weight: 700;
        color: rgba(10, 39, 64, 0.9);
      }

      .report-controls input,
      .report-controls select {
        width: 100%;
        min-width: 0;
        border: 1px solid rgba(13, 125, 189, 0.35);
        background: rgba(255, 255, 255, 0.9);
        color: var(--ink);
        border-radius: 8px;
        padding: 7px 10px;
        font-size: 0.9rem;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        gap: 8px;
      }

      .summary-card {
        border: 1px solid rgba(13, 125, 189, 0.28);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.82);
        padding: 10px;
      }

      .summary-card h3 {
        margin: 0 0 4px;
        font-size: 0.88rem;
        line-height: 1.25;
      }

      .summary-card p {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 700;
        color: #08547f;
      }

      .meta-line {
        margin: 0 0 10px;
        font-size: 0.86rem;
        color: rgba(10, 39, 64, 0.82);
      }

      .table-wrap {
        overflow: auto;
        border: 1px solid rgba(13, 125, 189, 0.22);
        border-radius: 10px;
      }

      .report-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 0;
        table-layout: fixed;
        font-size: 0.8rem;
      }

      .report-table thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: left;
        background: rgba(10, 84, 127, 0.95);
        color: #fff;
        padding: 7px 8px;
      }

      .report-table tbody td {
        border-bottom: 1px solid rgba(13, 125, 189, 0.16);
        padding: 6px 7px;
        vertical-align: top;
        white-space: normal;
        word-break: break-word;
        line-height: 1.3;
      }

      .report-table th:nth-child(1),
      .report-table td:nth-child(1) {
        width: 13.5ch;
      }

      .report-table th:nth-child(2),
      .report-table td:nth-child(2) {
        width: 18%;
      }

      .report-table th:nth-child(3),
      .report-table td:nth-child(3) {
        width: 24%;
      }

      .report-table th:nth-child(4),
      .report-table td:nth-child(4) {
        width: 12%;
      }

      .report-table th:nth-child(5),
      .report-table td:nth-child(5) {
        width: 7.5%;
      }

      .report-table th:nth-child(6),
      .report-table td:nth-child(6) {
        width: 17%;
      }

      .report-table tbody tr:hover {
        background: rgba(13, 125, 189, 0.08);
      }

      .program-name-main {
        font-weight: 600;
      }

      .program-name-sub {
        margin-top: 2px;
        font-size: 0.74rem;
        color: rgba(10, 39, 64, 0.7);
      }

      .delta-up {
        color: #0a6c3b;
        font-weight: 700;
      }

      .delta-down {
        color: #9b1c1c;
        font-weight: 700;
      }

      .delta-neutral {
        color: rgba(10, 39, 64, 0.76);
        font-weight: 600;
      }

      .pager {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
      }

      .pager button {
        border: 1px solid rgba(13, 125, 189, 0.35);
        background: rgba(255, 255, 255, 0.92);
        color: var(--ink);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 0.86rem;
        cursor: pointer;
      }

      .pager button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      .error-box-local {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(184, 56, 56, 0.35);
        background: rgba(255, 243, 243, 0.9);
        color: #7c1d1d;
        font-size: 0.9rem;
      }

      @media (max-width: 1380px) {
        .report-controls {
          grid-template-columns: repeat(3, minmax(180px, 1fr));
        }
      }

      @media (max-width: 920px) {
        .report-controls {
          grid-template-columns: repeat(2, minmax(160px, 1fr));
        }
      }

      @media (max-width: 620px) {
        .report-controls {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page" id="page">
      <p class="page-home-link"><a href="./index.html">Página Principal</a></p>
      <header class="page-header">
        <h1>Relatório de Mudança de Notas</h1>
        <p>
          Comparação por <code>código do programa</code> com foco em variação de
          <code>CD_CONCEITO_PROGRAMA</code> entre 2020 e 2024.
        </p>
        <div class="disclaimer">
          Aviso: mudanças de nota podem coexistir com reclassificação de área,
          além de ajustes cadastrais. As notas exibidas não são finais.
        </div>
      </header>

      <main class="page-content">
        <section class="chart-section">
          <h2 class="chart-title">Filtros e Resumo</h2>
          <div class="chart-wrap">
            <div class="report-controls">
              <div class="control">
                <label for="filtro-categoria">Categoria de Nota</label>
                <select id="filtro-categoria"></select>
              </div>
              <div class="control">
                <label for="filtro-presenca">Presença</label>
                <select id="filtro-presenca">
                  <option value="todas">Todas</option>
                  <option value="ambos">Presente em 2020 e 2024</option>
                  <option value="somente_2020">Somente 2020</option>
                  <option value="somente_2024">Somente 2024</option>
                </select>
              </div>
              <div class="control">
                <label for="filtro-area">Área</label>
                <select id="filtro-area">
                  <option value="todas">Todas</option>
                </select>
              </div>
              <div class="control">
                <label for="filtro-busca">Busca (ID, nome, IES)</label>
                <input id="filtro-busca" type="text" placeholder="Ex.: 330020... ou BIOLOGIA" />
              </div>
            </div>

            <p class="meta-line" id="meta-resumo">Carregando...</p>
            <div class="summary-grid" id="summary-grid"></div>
          </div>
        </section>

        <section class="chart-section">
          <h2 class="chart-title">Resultado Detalhado</h2>
          <div class="chart-wrap">
            <div class="table-wrap">
              <table class="report-table">
                <thead>
                  <tr>
                    <th>Cód. Programa</th>
                    <th>Categoria da Nota</th>
                    <th>Nome do Programa</th>
                    <th>Nota 2020 → 2024</th>
                    <th>Δ Nota</th>
                    <th>Área de Avaliação</th>
                  </tr>
                </thead>
                <tbody id="tabela-corpo"></tbody>
              </table>
            </div>

            <div class="pager">
              <button id="pagina-anterior">Página anterior</button>
              <span id="pagina-info">Página 1</span>
              <button id="pagina-proxima">Próxima página</button>
              <label for="pagina-tamanho">Linhas por página:</label>
              <select id="pagina-tamanho">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
              </select>
            </div>
          </div>
        </section>
      </main>
    </div>
    <footer class="site-footnote">
      <a href="http://linktr.ee/rafaeldcsantos">Rafael Santos</a>
    </footer>

    <script>
      (function () {
        const dataUrl = "./Data/programas-transicoes-2020-2024-detalhado.json";

        const el = {
          categoria: document.getElementById("filtro-categoria"),
          presenca: document.getElementById("filtro-presenca"),
          area: document.getElementById("filtro-area"),
          busca: document.getElementById("filtro-busca"),
          metaResumo: document.getElementById("meta-resumo"),
          summaryGrid: document.getElementById("summary-grid"),
          tabelaCorpo: document.getElementById("tabela-corpo"),
          paginaAnterior: document.getElementById("pagina-anterior"),
          paginaProxima: document.getElementById("pagina-proxima"),
          paginaInfo: document.getElementById("pagina-info"),
          paginaTamanho: document.getElementById("pagina-tamanho"),
        };

        const CATEGORY_ORDER = [
          "subiu_2_mais",
          "subiu_1",
          "manteve",
          "caiu_1",
          "caiu_2_mais",
          "nao_existia_2020",
          "existia_2020_ausente_2024",
          "sem_nota_2020_ou_2024",
          "nota_multipla_ambigua",
        ];

        const CATEGORY_LABELS = {
          subiu_2_mais: "Subiu 2 ou mais",
          subiu_1: "Subiu 1",
          manteve: "Manteve",
          caiu_1: "Caiu 1",
          caiu_2_mais: "Caiu 2 ou mais",
          nao_existia_2020: "Não existia em 2020",
          existia_2020_ausente_2024: "Existia em 2020 (ausente em 2024)",
          sem_nota_2020_ou_2024: "Sem nota em 2020 e/ou 2024",
          nota_multipla_ambigua: "Notas múltiplas (ambíguas)",
        };

        let allRows = [];
        let filteredRows = [];
        let page = 1;
        let pageSize = Number(el.paginaTamanho.value) || 50;

        function normalizeText(value) {
          return String(value || "")
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toUpperCase()
            .replace(/[^A-Z0-9 ]+/g, " ")
            .replace(/\s+/g, " ")
            .trim();
        }

        function toList(value) {
          if (Array.isArray(value)) {
            return value;
          }
          if (value === null || value === undefined || value === "") {
            return [];
          }
          return [value];
        }

        function toDisplay(value) {
          if (Array.isArray(value)) {
            return value.join(" | ");
          }
          if (value === null || value === undefined || value === "") {
            return "-";
          }
          return String(value);
        }

        function toCodeList(areaInfo) {
          if (!areaInfo) {
            return [];
          }
          return toList(areaInfo.codigo).map((v) => String(v));
        }

        function parseNoteValue(value) {
          if (value === null || value === undefined || value === "") {
            return null;
          }
          const parsed = Number(String(value).trim().replace(",", "."));
          if (!Number.isFinite(parsed)) {
            return null;
          }
          if (Math.abs(parsed - Math.round(parsed)) < 1e-9) {
            return Math.round(parsed);
          }
          return parsed;
        }

        function extractNoteSet(value) {
          const out = new Set();
          toList(value).forEach((v) => {
            const parsed = parseNoteValue(v);
            if (Number.isFinite(parsed)) {
              out.add(parsed);
            }
          });
          return [...out].sort((a, b) => a - b);
        }

        function formatNoteSet(notes) {
          if (!Array.isArray(notes) || !notes.length) {
            return "-";
          }
          return notes.map((n) => String(n)).join(" | ");
        }

        function formatDelta(delta) {
          if (!Number.isFinite(delta)) {
            return "";
          }
          if (delta > 0) {
            return `<span class="delta-up">+${delta}</span>`;
          }
          if (delta < 0) {
            return `<span class="delta-down">${delta}</span>`;
          }
          return `<span class="delta-neutral">0</span>`;
        }

        function areaToText(areaInfo) {
          if (!areaInfo) {
            return "-";
          }
          const code = toDisplay(areaInfo.codigo);
          const abbr = toDisplay(areaInfo.abreviatura);
          const name = toDisplay(areaInfo.nome);
          if (abbr !== "-" && abbr !== "null") {
            return `${code} (${abbr})`;
          }
          if (name !== "-" && name !== "null") {
            return `${code} (${name})`;
          }
          return code;
        }

        function classifyByNote(row) {
          const present2020 = Boolean(row.presente_2020);
          const present2024 = Boolean(row.presente_2024);
          const dados2020 = row.dados_2020 || {};
          const dados2024 = row.dados_2024 || {};

          const notes2020 = extractNoteSet(dados2020.CD_CONCEITO_PROGRAMA);
          const notes2024 = extractNoteSet(dados2024.CD_CONCEITO_PROGRAMA);

          let categoria = "sem_nota_2020_ou_2024";
          let delta = null;

          if (!present2020 && present2024) {
            categoria = "nao_existia_2020";
          } else if (present2020 && !present2024) {
            categoria = "existia_2020_ausente_2024";
          } else if (!present2020 && !present2024) {
            categoria = "sem_nota_2020_ou_2024";
          } else if (!notes2020.length || !notes2024.length) {
            categoria = "sem_nota_2020_ou_2024";
          } else if (notes2020.length === 1 && notes2024.length === 1) {
            delta = notes2024[0] - notes2020[0];
            if (delta >= 2) {
              categoria = "subiu_2_mais";
            } else if (delta === 1) {
              categoria = "subiu_1";
            } else if (delta === 0) {
              categoria = "manteve";
            } else if (delta === -1) {
              categoria = "caiu_1";
            } else {
              categoria = "caiu_2_mais";
            }
          } else {
            const min20 = notes2020[0];
            const max20 = notes2020[notes2020.length - 1];
            const min24 = notes2024[0];
            const max24 = notes2024[notes2024.length - 1];

            if (min24 > max20) {
              categoria = min24 - max20 >= 2 ? "subiu_2_mais" : "subiu_1";
            } else if (max24 < min20) {
              categoria = min20 - max24 >= 2 ? "caiu_2_mais" : "caiu_1";
            } else if (min20 === min24 && max20 === max24) {
              categoria = "manteve";
            } else {
              categoria = "nota_multipla_ambigua";
            }
          }

          return {
            categoria,
            categoria_rotulo: CATEGORY_LABELS[categoria] || categoria,
            nota_2020_set: notes2020,
            nota_2024_set: notes2024,
            delta_nota: delta,
          };
        }

        function enrichRows(rows) {
          return rows.map((row) => {
            const cls = classifyByNote(row);
            const nome =
              (row.dados_2024 && row.dados_2024.NM_PROGRAMA_IES) ||
              (row.dados_2020 && row.dados_2020.NM_PROGRAMA_IES) ||
              "-";
            const sigla =
              (row.dados_2024 && row.dados_2024.SG_ENTIDADE_ENSINO) ||
              (row.dados_2020 && row.dados_2020.SG_ENTIDADE_ENSINO) ||
              "";

            return {
              ...row,
              categoria_nota: cls.categoria,
              categoria_nota_rotulo: cls.categoria_rotulo,
              nota_2020_set: cls.nota_2020_set,
              nota_2024_set: cls.nota_2024_set,
              delta_nota: cls.delta_nota,
              nome_programa: nome,
              sigla_entidade_ensino: sigla,
            };
          });
        }

        function buildCategoryOptions() {
          const options = [
            '<option value="todas">Todas</option>',
            '<option value="subiu_any">Subiu (qualquer)</option>',
            '<option value="caiu_any">Caiu (qualquer)</option>',
          ];
          CATEGORY_ORDER.forEach((key) => {
            options.push(`<option value="${key}">${CATEGORY_LABELS[key] || key}</option>`);
          });
          el.categoria.innerHTML = options.join("");
        }

        function buildAreaOptions(rows) {
          const set = new Set();
          const abbrByCode = new Map();

          function registerArea(areaInfo) {
            if (!areaInfo) {
              return;
            }
            const codes = toList(areaInfo.codigo).map((v) => String(v));
            const abbrs = toList(areaInfo.abreviatura).map((v) =>
              v === null || v === undefined ? "" : String(v).trim()
            );

            codes.forEach((code, idx) => {
              if (!code || code === "null") {
                return;
              }
              const abbr = abbrs[idx] || (abbrs.length === 1 ? abbrs[0] : "");
              if (!abbrByCode.has(code) || (!abbrByCode.get(code) && abbr)) {
                abbrByCode.set(code, abbr);
              }
              set.add(code);
            });
          }

          rows.forEach((row) => {
            registerArea(row.comparacao && row.comparacao.area_2020);
            registerArea(row.comparacao && row.comparacao.area_2024);
          });

          const options = ['<option value="todas">Todas</option>'];
          [...set]
            .filter(Boolean)
            .sort((a, b) => {
              const na = Number(a);
              const nb = Number(b);
              if (Number.isFinite(na) && Number.isFinite(nb)) {
                return na - nb;
              }
              return String(a).localeCompare(String(b), "pt-BR");
            })
            .forEach((area) => {
              const abbr = abbrByCode.get(area);
              const label = abbr ? `${area} (${abbr})` : area;
              options.push(`<option value="${area}">${label}</option>`);
            });
          el.area.innerHTML = options.join("");
        }

        function matchesPresence(row, presence) {
          if (presence === "todas") {
            return true;
          }
          if (presence === "ambos") {
            return row.presente_2020 && row.presente_2024;
          }
          if (presence === "somente_2020") {
            return row.presente_2020 && !row.presente_2024;
          }
          if (presence === "somente_2024") {
            return !row.presente_2020 && row.presente_2024;
          }
          return true;
        }

        function matchesCategory(row, categoria) {
          if (categoria === "todas") {
            return true;
          }
          if (categoria === "subiu_any") {
            return row.categoria_nota === "subiu_1" || row.categoria_nota === "subiu_2_mais";
          }
          if (categoria === "caiu_any") {
            return row.categoria_nota === "caiu_1" || row.categoria_nota === "caiu_2_mais";
          }
          return row.categoria_nota === categoria;
        }

        function applyFilters() {
          const categoria = el.categoria.value;
          const presenca = el.presenca.value;
          const area = el.area.value;
          const busca = normalizeText(el.busca.value);

          filteredRows = allRows.filter((row) => {
            if (!matchesCategory(row, categoria)) {
              return false;
            }

            if (!matchesPresence(row, presenca)) {
              return false;
            }

            if (area !== "todas") {
              const areas = [
                ...toCodeList(row.comparacao && row.comparacao.area_2020),
                ...toCodeList(row.comparacao && row.comparacao.area_2024),
              ];
              if (!areas.includes(area)) {
                return false;
              }
            }

            if (busca) {
              const text = normalizeText(
                [
                  row.cd_programa_ies,
                  row.nome_programa,
                  row.sigla_entidade_ensino,
                  ...row.nota_2020_set,
                  ...row.nota_2024_set,
                ]
                  .filter(Boolean)
                  .join(" ")
              );
              if (!text.includes(busca)) {
                return false;
              }
            }

            return true;
          });

          page = 1;
          renderSummary();
          renderTable();
        }

        function renderSummary() {
          const total = filteredRows.length;
          const categoryCounts = {};
          filteredRows.forEach((row) => {
            categoryCounts[row.categoria_nota] = (categoryCounts[row.categoria_nota] || 0) + 1;
          });

          const cards = [];
          CATEGORY_ORDER.forEach((cat) => {
            const count = categoryCounts[cat] || 0;
            cards.push(
              `<article class="summary-card">
                <h3>${CATEGORY_LABELS[cat] || cat}</h3>
                <p>${count.toLocaleString("pt-BR")}</p>
              </article>`
            );
          });

          el.summaryGrid.innerHTML = cards.join("");
          el.metaResumo.textContent = `Registros filtrados: ${total.toLocaleString("pt-BR")} de ${allRows.length.toLocaleString("pt-BR")}.`;
        }

        function renderTable() {
          const totalPages = Math.max(1, Math.ceil(filteredRows.length / pageSize));
          if (page > totalPages) {
            page = totalPages;
          }
          const start = (page - 1) * pageSize;
          const end = start + pageSize;
          const rows = filteredRows.slice(start, end);

          const html = rows
            .map((row) => {
              const cmp = row.comparacao || {};
              const areaAtual = areaToText(cmp.area_2024);
              const areaFallback = areaToText(cmp.area_2020);
              const areaText = areaAtual !== "-" ? areaAtual : areaFallback;
              const notaText = `${formatNoteSet(row.nota_2020_set)} → ${formatNoteSet(row.nota_2024_set)}`;
              const deltaText = formatDelta(row.delta_nota) || "-";

              return `<tr>
                <td>${row.cd_programa_ies}</td>
                <td>${row.categoria_nota_rotulo}</td>
                <td>
                  <div class="program-name-main">${toDisplay(row.nome_programa)}</div>
                  ${
                    row.sigla_entidade_ensino
                      ? `<div class="program-name-sub">${toDisplay(row.sigla_entidade_ensino)}</div>`
                      : ""
                  }
                </td>
                <td>${notaText}</td>
                <td>${deltaText}</td>
                <td>${areaText}</td>
              </tr>`;
            })
            .join("");

          el.tabelaCorpo.innerHTML = html || "<tr><td colspan='6'>Nenhum registro para os filtros.</td></tr>";
          el.paginaInfo.textContent = `Página ${page} de ${totalPages}`;
          el.paginaAnterior.disabled = page <= 1;
          el.paginaProxima.disabled = page >= totalPages;
        }

        function wireEvents() {
          [el.categoria, el.presenca, el.area, el.busca].forEach((node) =>
            node.addEventListener("input", applyFilters)
          );

          el.paginaAnterior.addEventListener("click", () => {
            if (page > 1) {
              page -= 1;
              renderTable();
            }
          });

          el.paginaProxima.addEventListener("click", () => {
            const totalPages = Math.max(1, Math.ceil(filteredRows.length / pageSize));
            if (page < totalPages) {
              page += 1;
              renderTable();
            }
          });

          el.paginaTamanho.addEventListener("change", () => {
            pageSize = Number(el.paginaTamanho.value) || 50;
            page = 1;
            renderTable();
          });
        }

        function showError(message) {
          const box = document.createElement("div");
          box.className = "error-box-local";
          box.textContent = message;
          const firstSection = document.querySelector(".chart-section .chart-wrap");
          if (firstSection) {
            firstSection.appendChild(box);
          }
        }

        fetch(dataUrl)
          .then((resp) => {
            if (!resp.ok) {
              throw new Error(`Falha ao carregar ${dataUrl}: HTTP ${resp.status}`);
            }
            return resp.json();
          })
          .then((payload) => {
            const baseRows = Array.isArray(payload.programas) ? payload.programas : [];
            allRows = enrichRows(baseRows);
            buildCategoryOptions();
            buildAreaOptions(allRows);
            wireEvents();
            applyFilters();
          })
          .catch((error) => {
            showError(error.message || String(error));
          });
      })();
    </script>
  </body>
</html>
